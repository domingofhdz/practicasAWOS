<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <style>
        .btn-whatsapp:hover {
            background: none;
            border: solid 2px green !important;
            color: green !important;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Hello, world!</h1>
    
        <div id="divMapa" style="height: 250px;"></div>
    
        <form id="frmUbicacion" method="POST">
            <input type="hidden" id="hidId" name="hidId">
            <div class="mb-1">
                <label for="txtDescripcion">Descripción:</label>
                <textarea name="txtDescripcion" id="txtDescripcion" class="form-control" rows="3"></textarea>
            </div>
            <input type="hidden" id="hidLatitud" name="hidLatitud" readonly>
            <input type="hidden" id="hidLongitud" name="hidLongitud" readonly>
            <div class="mt-1 mb-1">
                <button class="btn btn-primary">Guardar</button>
                <button type="reset" class="btn btn-secondary">Cancelar</button>
            </div>
        </form>

        <table class="table table-sm table-bordered">
            <thead>
                <tr>
                    <th>Descripción</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="tbodyUbicaciones"></tbody>
        </table>
    </div>

    <a href="https://wa.me/5218621248706?text=Hola" target="_blank" class="btn btn-success rounded rounded-circle btn-whatsapp" style="
        position: fixed;
        bottom: 5px;
        right: 5px;
        font-size: 2em;
    ">
        <i class="bi bi-whatsapp"></i>
    </a>

    <script>
        const options = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0,
        }

        function generarMapa(longitud, latitud) {
            $("#divMapa").html(`

            <iframe src="https://www.google.com/maps/embed?pb=!1m14!1m12!1m3!1d7007.717655366165!2d${longitud}!3d${latitud}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!5e0!3m2!1ses!2smx!4v1728407007773!5m2!1ses!2smx" class="w-100" height="250" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>

            `)
        }

        function success(pos) {
            const crd = pos.coords

            const longitud = crd.longitude
            const latitud = crd.latitude
            const precision = crd.accuracy

            console.log("Your current position is:")
            console.log(`Latitude : ${latitud}`)
            console.log(`Longitude: ${longitud}`)
            console.log(`More or less ${precision} meters.`)

            generarMapa(longitud, latitud)

            $("#hidLatitud").val(latitud)
            $("#hidLongitud").val(longitud)
        }

        function error(err) {
            console.warn(`ERROR(${err.code}): ${err.message}`)
        }

        function buscarUbicaciones() {
            $.get("servicioUbicaciones.php?buscarUbicaciones", function (ubicaciones) {
                $("#tbodyUbicaciones").html("")

                for (let x in ubicaciones) {
                    const ubicacion = ubicaciones[x]
                    const id = ubicacion.idReporte
                    const descripcion = ubicacion.descripcion

                    $("#tbodyUbicaciones").append(`
                    <tr>
                        <td>${descripcion}</td>
                        <td>
                            <button class="btn btn-info btn-editar-ubicacion" data-id="${id}">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>
                    `)
                }
            })
        }

        function obtenerUbicacion() {
            navigator.geolocation.getCurrentPosition(success, error, options)
        }

        buscarUbicaciones()
        obtenerUbicacion()

        $("#frmUbicacion")
        .submit(function (event) {
            event.preventDefault()

            $.post("servicioUbicaciones.php?agregarUbicacion", $(this).serialize(), function (respuesta) {
                if (respuesta) {
                    alert("Ubicación registrada!")
                }
            })
        })
        .on("reset", function (event) {
            $("#hidId").val("")
            obtenerUbicacion()
        })

        $(document).on("click", ".btn-editar-ubicacion", function (event) {
            const idUbicacion = $(this).data("id")

            $.get("servicioUbicaciones.php?editarUbicacion", {
                id: idUbicacion
            }, function (ubicaciones) {
                const ubicacion = ubicaciones[0]
                const id = ubicacion.idReporte
                const descripcion = ubicacion.descripcion
                const latitud = ubicacion.latitud
                const longitud = ubicacion.longitud

                $("#hidId").val(id)
                $("#txtDescripcion").val(descripcion)
                $("#hidLatitud").val(latitud)
                $("#hidLongitud").val(longitud)

                generarMapa(longitud, latitud)
            })
        })
    </script>

</body>
</html>
